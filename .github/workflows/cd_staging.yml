name: Deploy to Pagesmith (DigitalOcean)

on:
  push:
    branches:
      - main

jobs:
  deploy_pagesmith:
    name: Deploy Pagesmith to DigitalOcean
    runs-on: ubuntu-latest

    steps:
      - name: SSH into DigitalOcean and deploy
        run: |
          # Save the private key from GitHub secrets
          echo "${{ secrets.SSH_PRIVATE_KEY_DO }}" > ssh_key
          chmod 600 ssh_key

          # SSH into DigitalOcean droplet and run deployment
          ssh -o StrictHostKeyChecking=no -i ssh_key root@159.65.159.179 << 'EOF'
            set -e

            # Update system package info
            apt update -y

            # Install Node.js 20 (Ubuntu 24.04 ships with it via NodeSource or Snap)
            if ! command -v node >/dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt install -y nodejs
            fi

            # Install pnpm (via corepack)
            if ! command -v pnpm >/dev/null; then
              corepack enable
              corepack prepare pnpm@latest --activate
            fi

            # Install pm2 globally
            if ! command -v pm2 >/dev/null; then
              npm install -g pm2
            fi

            # Go to project and deploy
            cd Pagesmith && git pull origin main
            pnpm install
            pnpm run build

            # Restart or start PM2 processes
            pm2 restart http || pm2 start dist/http.js --name http
            pm2 restart web || pm2 start dist/wb.js --name wb
          EOF
